<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý sách - Thư viện Mini</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-book"></i>
                <h1>Thư viện Mini - Admin</h1>
            </div>
            <nav class="nav">
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="admin-books.html" class="nav-link active">Quản lý sách</a>
                <a href="admin-users.html" class="nav-link">Quản lý người dùng</a>
                <a href="admin-borrows.html" class="nav-link">Quản lý mượn trả</a>
                <a href="admin-reports.html" class="nav-link">Báo cáo</a>
            </nav>
            <div class="auth-buttons">
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Page Header -->
            <section class="page-header">
                <div class="header-content">
                    <h2><i class="fas fa-book"></i> Quản lý sách</h2>
                    <p>Thêm, sửa, xóa và quản lý toàn bộ sách trong thư viện</p>
                </div>
                <button class="btn btn-primary" onclick="openAddBookModal()">
                    <i class="fas fa-plus"></i> Thêm sách mới
                </button>
            </section>

            <!-- Statistics Cards -->
            <section class="admin-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalBooksCount">0</h3>
                        <p>Tổng số sách</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="availableBooksCount">0</h3>
                        <p>Sách có sẵn</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-hand-holding"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="borrowedBooksCount">0</h3>
                        <p>Sách đang mượn</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="categoriesCount">0</h3>
                        <p>Thể loại</p>
                    </div>
                </div>
            </section>

            <!-- Filters and Search -->
            <section class="admin-filters">
                <div class="filter-row">
                    <div class="form-group">
                        <label for="bookSearchAdmin">Tìm kiếm sách</label>
                        <input type="text" id="bookSearchAdmin" placeholder="Tên sách, tác giả...">
                    </div>
                    <div class="form-group">
                        <label for="categoryFilterAdmin">Thể loại</label>
                        <select id="categoryFilterAdmin">
                            <option value="">Tất cả thể loại</option>
                            <option value="Kỹ năng sống">Kỹ năng sống</option>
                            <option value="Phát triển bản thân">Phát triển bản thân</option>
                            <option value="Tiểu thuyết">Tiểu thuyết</option>
                            <option value="Lịch sử">Lịch sử</option>
                            <option value="Khoa học">Khoa học</option>
                            <option value="Văn học">Văn học</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statusFilterAdmin">Trạng thái</label>
                        <select id="statusFilterAdmin">
                            <option value="">Tất cả</option>
                            <option value="available">Có sẵn</option>
                            <option value="borrowed">Đang mượn</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="applyAdminFilters()">
                            <i class="fas fa-search"></i> Lọc
                        </button>
                        <button class="btn btn-outline" onclick="clearAdminFilters()">
                            <i class="fas fa-times"></i> Xóa
                        </button>
                    </div>
                </div>
            </section>

            <!-- Books Management Table -->
            <section class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> Danh sách sách</h3>
                    <div class="bulk-actions">
                        <button class="btn btn-success btn-small" onclick="bulkAction('activate')" style="display: none;">
                            <i class="fas fa-check"></i> Kích hoạt
                        </button>
                        <button class="btn btn-danger btn-small" onclick="bulkAction('delete')" style="display: none;">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllBooks" onchange="toggleSelectAll()">
                                </th>
                                <th>Hình ảnh</th>
                                <th>Tên sách <i class="fas fa-sort" onclick="sortBooks('title')"></i></th>
                                <th>Tác giả <i class="fas fa-sort" onclick="sortBooks('author')"></i></th>
                                <th>Thể loại</th>
                                <th>Trạng thái</th>
                                <th>Lượt mượn <i class="fas fa-sort" onclick="sortBooks('borrowCount')"></i></th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="booksAdminTableBody">
                            <!-- Books will be loaded here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="adminPagination" class="pagination">
                    <!-- Pagination will be generated by JavaScript -->
                </div>
            </section>
        </div>
    </main>

    <!-- Add/Edit Book Modal -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bookModal')">&times;</span>
            <h3 id="bookModalTitle">Thêm sách mới</h3>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="bookTitle">Tên sách *</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Tác giả *</label>
                        <input type="text" id="bookAuthor" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bookCategory">Thể loại *</label>
                        <select id="bookCategory" required>
                            <option value="">Chọn thể loại</option>
                            <option value="Kỹ năng sống">Kỹ năng sống</option>
                            <option value="Phát triển bản thân">Phát triển bản thân</option>
                            <option value="Tiểu thuyết">Tiểu thuyết</option>
                            <option value="Lịch sử">Lịch sử</option>
                            <option value="Khoa học">Khoa học</option>
                            <option value="Văn học">Văn học</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookStatus">Trạng thái</label>
                        <select id="bookStatus">
                            <option value="available">Có sẵn</option>
                            <option value="borrowed">Đã mượn</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bookDescription">Mô tả</label>
                    <textarea id="bookDescription" rows="4" placeholder="Nhập mô tả về cuốn sách..."></textarea>
                </div>

                <div class="form-group">
                    <label for="bookImage">URL hình ảnh</label>
                    <input type="url" id="bookImage" placeholder="https://example.com/image.jpg">
                    <small>Để trống để sử dụng hình ảnh mặc định</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('bookModal')">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="saveButtonText">Thêm sách</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deleteModal')">&times;</span>
            <div class="delete-confirmation">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Xác nhận xóa sách</h3>
                <p>Bạn có chắc chắn muốn xóa sách này không? Hành động này không thể hoàn tác.</p>
                <div class="form-actions">
                    <button class="btn btn-outline" onclick="closeModal('deleteModal')">Hủy</button>
                    <button class="btn btn-danger" onclick="confirmDelete()">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        let currentBookPage = 1;
        let booksPerPage = 10;
        let filteredAdminBooks = [];
        let sortField = '';
        let sortDirection = 'asc';
        let selectedBooks = new Set();
        let bookToDelete = null;

        // Initialize admin books page
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin authentication
            if (!window.libraryApp.currentUser || window.libraryApp.currentUser.role !== 'admin') {
                window.location.href = 'index.html';
                return;
            }
            
            loadAdminBooks();
            setupAdminEventListeners();
        });

        function loadAdminBooks() {
            filteredAdminBooks = [...window.libraryApp.books];
            updateAdminStats();
            renderAdminBooksTable();
            renderAdminPagination();
        }

        function updateAdminStats() {
            const totalBooks = window.libraryApp.books.length;
            const availableBooks = window.libraryApp.books.filter(b => b.status === 'available').length;
            const borrowedBooks = window.libraryApp.books.filter(b => b.status === 'borrowed').length;
            const categories = new Set(window.libraryApp.books.map(b => b.category)).size;

            document.getElementById('totalBooksCount').textContent = totalBooks;
            document.getElementById('availableBooksCount').textContent = availableBooks;
            document.getElementById('borrowedBooksCount').textContent = borrowedBooks;
            document.getElementById('categoriesCount').textContent = categories;
        }

        function renderAdminBooksTable() {
            const startIndex = (currentBookPage - 1) * booksPerPage;
            const endIndex = startIndex + booksPerPage;
            const booksToShow = filteredAdminBooks.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('booksAdminTableBody');
            
            if (booksToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không tìm thấy sách nào</td></tr>';
                return;
            }

            tbody.innerHTML = booksToShow.map(book => `
                <tr>
                    <td>
                        <input type="checkbox" value="${book.id}" onchange="toggleBookSelect(${book.id})">
                    </td>
                    <td>
                        <img src="${book.image}" alt="${book.title}" class="book-thumb">
                    </td>
                    <td>
                        <strong>${book.title}</strong>
                    </td>
                    <td>${book.author}</td>
                    <td>
                        <span class="category-tag">${book.category}</span>
                    </td>
                    <td>
                        <span class="status-badge ${book.status}">
                            ${book.status === 'available' ? 'Có sẵn' : 'Đã mượn'}
                        </span>
                    </td>
                    <td>
                        <span class="borrow-count">${book.borrowCount || 0}</span>
                    </td>
                    <td class="actions">
                        <button class="btn btn-primary btn-small" onclick="editBook(${book.id})" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info btn-small" onclick="viewBookAdmin(${book.id})" title="Xem">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteBook(${book.id})" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderAdminPagination() {
            const totalPages = Math.ceil(filteredAdminBooks.length / booksPerPage);
            const pagination = document.getElementById('adminPagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            if (currentBookPage > 1) {
                paginationHTML += `
                    <button class="btn btn-outline btn-small" onclick="changeAdminPage(${currentBookPage - 1})">
                        <i class="fas fa-chevron-left"></i> Trước
                    </button>
                `;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentBookPage - 2);
            const endPage = Math.min(totalPages, currentBookPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button class="btn btn-outline btn-small" onclick="changeAdminPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span>...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentBookPage) {
                    paginationHTML += `<button class="btn btn-primary btn-small">${i}</button>`;
                } else {
                    paginationHTML += `<button class="btn btn-outline btn-small" onclick="changeAdminPage(${i})">${i}</button>`;
                }
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span>...</span>`;
                }
                paginationHTML += `<button class="btn btn-outline btn-small" onclick="changeAdminPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            if (currentBookPage < totalPages) {
                paginationHTML += `
                    <button class="btn btn-outline btn-small" onclick="changeAdminPage(${currentBookPage + 1})">
                        Sau <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        function setupAdminEventListeners() {
            // Search and filter inputs
            document.getElementById('bookSearchAdmin').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    applyAdminFilters();
                }
            });

            document.getElementById('categoryFilterAdmin').addEventListener('change', applyAdminFilters);
            document.getElementById('statusFilterAdmin').addEventListener('change', applyAdminFilters);

            // Book form
            document.getElementById('bookForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveBook();
            });
        }

        function applyAdminFilters() {
            const searchQuery = document.getElementById('bookSearchAdmin').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilterAdmin').value;
            const statusFilter = document.getElementById('statusFilterAdmin').value;
            
            filteredAdminBooks = window.libraryApp.books.filter(book => {
                const matchesSearch = !searchQuery || 
                    book.title.toLowerCase().includes(searchQuery) ||
                    book.author.toLowerCase().includes(searchQuery);
                
                const matchesCategory = !categoryFilter || book.category === categoryFilter;
                const matchesStatus = !statusFilter || book.status === statusFilter;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            // Apply sorting if any
            if (sortField) {
                applySorting();
            }
            
            currentBookPage = 1;
            renderAdminBooksTable();
            renderAdminPagination();
        }

        function clearAdminFilters() {
            document.getElementById('bookSearchAdmin').value = '';
            document.getElementById('categoryFilterAdmin').value = '';
            document.getElementById('statusFilterAdmin').value = '';
            
            filteredAdminBooks = [...window.libraryApp.books];
            currentBookPage = 1;
            sortField = '';
            sortDirection = 'asc';
            
            renderAdminBooksTable();
            renderAdminPagination();
        }

        function sortBooks(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            
            applySorting();
            renderAdminBooksTable();
        }

        function applySorting() {
            filteredAdminBooks.sort((a, b) => {
                let valueA = a[sortField];
                let valueB = b[sortField];
                
                if (sortField === 'borrowCount') {
                    valueA = valueA || 0;
                    valueB = valueB || 0;
                } else {
                    valueA = (valueA || '').toString().toLowerCase();
                    valueB = (valueB || '').toString().toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
        }

        function changeAdminPage(page) {
            currentBookPage = page;
            renderAdminBooksTable();
            renderAdminPagination();
        }

        function openAddBookModal() {
            document.getElementById('bookModalTitle').textContent = 'Thêm sách mới';
            document.getElementById('saveButtonText').textContent = 'Thêm sách';
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('bookStatus').value = 'available';
            document.getElementById('bookModal').style.display = 'block';
        }

        function editBook(bookId) {
            const book = window.libraryApp.books.find(b => b.id === bookId);
            if (!book) return;

            document.getElementById('bookModalTitle').textContent = 'Sửa thông tin sách';
            document.getElementById('saveButtonText').textContent = 'Cập nhật';
            
            document.getElementById('bookId').value = book.id;
            document.getElementById('bookTitle').value = book.title;
            document.getElementById('bookAuthor').value = book.author;
            document.getElementById('bookCategory').value = book.category;
            document.getElementById('bookStatus').value = book.status;
            document.getElementById('bookDescription').value = book.description || '';
            document.getElementById('bookImage').value = book.image || '';
            
            document.getElementById('bookModal').style.display = 'block';
        }

        function saveBook() {
            const bookId = document.getElementById('bookId').value;
            const bookData = {
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                category: document.getElementById('bookCategory').value,
                status: document.getElementById('bookStatus').value,
                description: document.getElementById('bookDescription').value,
                image: document.getElementById('bookImage').value || 
                       `https://via.placeholder.com/200x280/667eea/ffffff?text=${encodeURIComponent(document.getElementById('bookTitle').value)}`
            };

            if (bookId) {
                // Update existing book
                if (window.libraryApp.updateBook(parseInt(bookId), bookData)) {
                    closeModal('bookModal');
                    loadAdminBooks();
                }
            } else {
                // Add new book
                if (window.libraryApp.addBook(bookData)) {
                    closeModal('bookModal');
                    loadAdminBooks();
                }
            }
        }

        function viewBookAdmin(bookId) {
            const book = window.libraryApp.books.find(b => b.id === bookId);
            if (!book) return;

            // Create a simple view modal or redirect to detail page
            alert(`Thông tin sách:\n\nTên: ${book.title}\nTác giả: ${book.author}\nThể loại: ${book.category}\nTrạng thái: ${book.status === 'available' ? 'Có sẵn' : 'Đã mượn'}\nMô tả: ${book.description || 'Không có mô tả'}`);
        }

        function deleteBook(bookId) {
            bookToDelete = bookId;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function confirmDelete() {
            if (bookToDelete && window.libraryApp.deleteBook(bookToDelete)) {
                closeModal('deleteModal');
                loadAdminBooks();
                bookToDelete = null;
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllBooks');
            const bookCheckboxes = document.querySelectorAll('#booksAdminTableBody input[type="checkbox"]');
            
            bookCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                const bookId = parseInt(checkbox.value);
                if (selectAllCheckbox.checked) {
                    selectedBooks.add(bookId);
                } else {
                    selectedBooks.delete(bookId);
                }
            });
            
            updateBulkActions();
        }

        function toggleBookSelect(bookId) {
            if (selectedBooks.has(bookId)) {
                selectedBooks.delete(bookId);
            } else {
                selectedBooks.add(bookId);
            }
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkButtons = document.querySelectorAll('.bulk-actions button');
            if (selectedBooks.size > 0) {
                bulkButtons.forEach(btn => btn.style.display = 'inline-block');
            } else {
                bulkButtons.forEach(btn => btn.style.display = 'none');
            }
        }

        function bulkAction(action) {
            if (selectedBooks.size === 0) return;
            
            const selectedBooksArray = Array.from(selectedBooks);
            
            if (action === 'delete') {
                if (confirm(`Bạn có chắc chắn muốn xóa ${selectedBooksArray.length} sách đã chọn?`)) {
                    selectedBooksArray.forEach(bookId => {
                        window.libraryApp.deleteBook(bookId);
                    });
                    selectedBooks.clear();
                    loadAdminBooks();
                }
            } else if (action === 'activate') {
                selectedBooksArray.forEach(bookId => {
                    window.libraryApp.updateBook(bookId, { status: 'available' });
                });
                selectedBooks.clear();
                loadAdminBooks();
                window.libraryApp.showAlert(`Đã kích hoạt ${selectedBooksArray.length} sách`);
            }
        }
    </script>

    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .page-header h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .admin-stats .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-stats .stat-icon {
            background: #f8f9ff;
            color: #667eea;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .admin-filters {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
        }

        .book-thumb {
            width: 40px;
            height: 55px;
            object-fit: cover;
            border-radius: 4px;
        }

        .category-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .borrow-count {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .delete-confirmation {
            text-align: center;
            padding: 1rem;
        }

        .delete-confirmation i {
            font-size: 3rem;
            color: #ff6b6b;
            margin-bottom: 1rem;
        }

        .delete-confirmation h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .delete-confirmation p {
            color: #666;
            margin-bottom: 2rem;
        }

        .data-table th i.fas {
            margin-left: 5px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .data-table th i.fas:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .bulk-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</body>
</html>