<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo thống kê - Thư viện Mini</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-book"></i>
                <h1>Thư viện Mini - Admin</h1>
            </div>
            <nav class="nav">
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="admin-books.html" class="nav-link">Quản lý sách</a>
                <a href="admin-users.html" class="nav-link">Quản lý người dùng</a>
                <a href="admin-borrows.html" class="nav-link">Quản lý mượn trả</a>
                <a href="admin-reports.html" class="nav-link active">Báo cáo</a>
            </nav>
            <div class="auth-buttons">
                <button class="btn btn-outline" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Page Header -->
            <section class="page-header">
                <div class="header-content">
                    <h2><i class="fas fa-chart-bar"></i> Báo cáo thống kê</h2>
                    <p>Theo dõi và phân tích hiệu quả hoạt động của thư viện</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="exportReport()">
                        <i class="fas fa-download"></i> Xuất báo cáo
                    </button>
                    <button class="btn btn-outline" onclick="refreshReports()">
                        <i class="fas fa-sync-alt"></i> Làm mới
                    </button>
                </div>
            </section>

            <!-- Time Range Filter -->
            <section class="time-filter">
                <div class="filter-card">
                    <h3>Khoảng thời gian</h3>
                    <div class="filter-options">
                        <button class="filter-btn active" data-period="7">7 ngày</button>
                        <button class="filter-btn" data-period="30">30 ngày</button>
                        <button class="filter-btn" data-period="90">3 tháng</button>
                        <button class="filter-btn" data-period="365">1 năm</button>
                        <button class="filter-btn" data-period="custom">Tùy chỉnh</button>
                    </div>
                    <div class="custom-range" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Từ ngày</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="form-group">
                                <label>Đến ngày</label>
                                <input type="date" id="endDate">
                            </div>
                            <button class="btn btn-primary" onclick="applyCustomRange()">Áp dụng</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Summary Cards -->
            <section class="summary-stats">
                <div class="stat-card gradient-blue">
                    <div class="stat-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalBorrowsInPeriod">0</h3>
                        <p>Lượt mượn trong kỳ</p>
                        <small id="borrowsChangePercent">+0% so với kỳ trước</small>
                    </div>
                </div>

                <div class="stat-card gradient-green">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsersInPeriod">0</h3>
                        <p>Người dùng hoạt động</p>
                        <small id="usersChangePercent">+0% so với kỳ trước</small>
                    </div>
                </div>

                <div class="stat-card gradient-orange">
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="avgBooksPerUser">0</h3>
                        <p>Sách/người dùng TB</p>
                        <small id="avgChangePercent">+0% so với kỳ trước</small>
                    </div>
                </div>

                <div class="stat-card gradient-purple">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="overdueRate">0%</h3>
                        <p>Tỷ lệ quá hạn</p>
                        <small id="overdueChangePercent">+0% so với kỳ trước</small>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="charts-section">
                <div class="chart-row">
                    <!-- Borrow Trends Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-line-chart"></i> Xu hướng mượn sách</h3>
                            <div class="chart-controls">
                                <select id="borrowTrendType">
                                    <option value="daily">Theo ngày</option>
                                    <option value="weekly">Theo tuần</option>
                                    <option value="monthly">Theo tháng</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="borrowTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Popular Books Chart -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-trophy"></i> Sách được mượn nhiều nhất</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="popularBooksChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-row">
                    <!-- Category Distribution -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-pie-chart"></i> Phân bố theo thể loại</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <!-- User Activity -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-user-clock"></i> Hoạt động người dùng</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="userActivityChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Detailed Reports -->
            <section class="detailed-reports">
                <div class="reports-tabs">
                    <button class="tab-btn active" data-tab="books">Báo cáo sách</button>
                    <button class="tab-btn" data-tab="users">Báo cáo người dùng</button>
                    <button class="tab-btn" data-tab="performance">Hiệu suất</button>
                </div>

                <!-- Books Report -->
                <div class="tab-content active" id="books-tab">
                    <div class="report-grid">
                        <div class="report-card">
                            <h4>Top 10 sách được mượn nhiều nhất</h4>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Sách</th>
                                            <th>Tác giả</th>
                                            <th>Số lần mượn</th>
                                            <th>Xu hướng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topBooksTable">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="report-card">
                            <h4>Sách ít được quan tâm</h4>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Sách</th>
                                            <th>Tác giả</th>
                                            <th>Số lần mượn</th>
                                            <th>Ngày thêm</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leastBorrowedBooksTable">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Report -->
                <div class="tab-content" id="users-tab">
                    <div class="report-grid">
                        <div class="report-card">
                            <h4>Người dùng tích cực nhất</h4>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Người dùng</th>
                                            <th>Email</th>
                                            <th>Số sách mượn</th>
                                            <th>Lần cuối hoạt động</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activeUsersTable">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="report-card">
                            <h4>Người dùng có sách quá hạn</h4>
                            <div class="report-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Người dùng</th>
                                            <th>Sách quá hạn</th>
                                            <th>Số ngày quá hạn</th>
                                            <th>Liên hệ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="overdueUsersTable">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Report -->
                <div class="tab-content" id="performance-tab">
                    <div class="performance-metrics">
                        <div class="metric-card">
                            <h4>Hiệu quả sử dụng thư viện</h4>
                            <div class="metric-value">
                                <span id="libraryEfficiency">85%</span>
                                <small>Tỷ lệ sách được mượn</small>
                            </div>
                            <div class="metric-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="efficiencyProgress" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h4>Thời gian mượn trung bình</h4>
                            <div class="metric-value">
                                <span id="avgBorrowTime">12 ngày</span>
                                <small>Trên mỗi lượt mượn</small>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h4>Tỷ lệ trả đúng hạn</h4>
                            <div class="metric-value">
                                <span id="onTimeReturnRate">92%</span>
                                <small>Trong tháng này</small>
                            </div>
                            <div class="metric-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="onTimeProgress" style="width: 92%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card">
                            <h4>Tăng trưởng người dùng</h4>
                            <div class="metric-value">
                                <span id="userGrowthRate">+15%</span>
                                <small>So với tháng trước</small>
                            </div>
                        </div>
                    </div>

                    <div class="recommendations">
                        <h4>Đề xuất cải thiện</h4>
                        <div class="recommendation-list" id="recommendationsList">
                            <!-- Recommendations will be generated here -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="js/main.js"></script>
    <script>
        let currentPeriod = 7;
        let borrowTrendChart, popularBooksChart, categoryChart, userActivityChart;

        // Initialize admin reports page
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin authentication
            if (!window.libraryApp.currentUser || window.libraryApp.currentUser.role !== 'admin') {
                window.location.href = 'index.html';
                return;
            }
            
            setupEventListeners();
            loadReportsData();
        });

        function setupEventListeners() {
            // Time filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const period = this.dataset.period;
                    if (period === 'custom') {
                        document.querySelector('.custom-range').style.display = 'block';
                    } else {
                        document.querySelector('.custom-range').style.display = 'none';
                        currentPeriod = parseInt(period);
                        loadReportsData();
                    }
                });
            });

            // Tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + '-tab').classList.add('active');
                });
            });

            // Chart type selector
            document.getElementById('borrowTrendType').addEventListener('change', function() {
                updateBorrowTrendChart();
            });

            // Set default dates
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        }

        function loadReportsData() {
            updateSummaryStats();
            createCharts();
            loadDetailedReports();
        }

        function updateSummaryStats() {
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - currentPeriod * 24 * 60 * 60 * 1000);
            
            // Filter data for current period
            const borrowsInPeriod = window.libraryApp.borrowRecords.filter(record => {
                const borrowDate = new Date(record.borrowDate);
                return borrowDate >= startDate && borrowDate <= endDate;
            });

            // Calculate previous period for comparison
            const prevStartDate = new Date(startDate.getTime() - currentPeriod * 24 * 60 * 60 * 1000);
            const borrowsInPrevPeriod = window.libraryApp.borrowRecords.filter(record => {
                const borrowDate = new Date(record.borrowDate);
                return borrowDate >= prevStartDate && borrowDate < startDate;
            });

            // Update summary stats
            document.getElementById('totalBorrowsInPeriod').textContent = borrowsInPeriod.length;
            
            const activeUsers = new Set(borrowsInPeriod.map(record => record.userId)).size;
            document.getElementById('activeUsersInPeriod').textContent = activeUsers;

            const avgBooksPerUser = activeUsers > 0 ? (borrowsInPeriod.length / activeUsers).toFixed(1) : 0;
            document.getElementById('avgBooksPerUser').textContent = avgBooksPerUser;

            const overdueBorrows = borrowsInPeriod.filter(record => {
                return record.status === 'borrowed' && new Date(record.dueDate) < new Date();
            });
            const overdueRate = borrowsInPeriod.length > 0 ? ((overdueBorrows.length / borrowsInPeriod.length) * 100).toFixed(1) : 0;
            document.getElementById('overdueRate').textContent = overdueRate + '%';

            // Calculate and display percentage changes
            const borrowsChange = calculatePercentageChange(borrowsInPeriod.length, borrowsInPrevPeriod.length);
            const prevActiveUsers = new Set(borrowsInPrevPeriod.map(record => record.userId)).size;
            const usersChange = calculatePercentageChange(activeUsers, prevActiveUsers);
            const prevAvgBooks = prevActiveUsers > 0 ? (borrowsInPrevPeriod.length / prevActiveUsers) : 0;
            const avgChange = calculatePercentageChange(parseFloat(avgBooksPerUser), prevAvgBooks);

            document.getElementById('borrowsChangePercent').textContent = formatChange(borrowsChange);
            document.getElementById('usersChangePercent').textContent = formatChange(usersChange);
            document.getElementById('avgChangePercent').textContent = formatChange(avgChange);
            document.getElementById('overdueChangePercent').textContent = formatChange(0); // Simplified for demo
        }

        function calculatePercentageChange(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous) * 100;
        }

        function formatChange(change) {
            const sign = change >= 0 ? '+' : '';
            return `${sign}${change.toFixed(1)}% so với kỳ trước`;
        }

        function createCharts() {
            createBorrowTrendChart();
            createPopularBooksChart();
            createCategoryChart();
            createUserActivityChart();
        }

        function createBorrowTrendChart() {
            const ctx = document.getElementById('borrowTrendChart').getContext('2d');
            
            // Generate data for the last 30 days
            const days = [];
            const borrowCounts = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                days.push(date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' }));
                
                const dayBorrows = window.libraryApp.borrowRecords.filter(record => 
                    record.borrowDate === dateStr
                ).length;
                borrowCounts.push(dayBorrows);
            }

            borrowTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Số lượt mượn',
                        data: borrowCounts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
        }

        function createPopularBooksChart() {
            const ctx = document.getElementById('popularBooksChart').getContext('2d');
            
            // Count borrows per book
            const bookBorrowCounts = {};
            window.libraryApp.borrowRecords.forEach(record => {
                bookBorrowCounts[record.bookId] = (bookBorrowCounts[record.bookId] || 0) + 1;
            });

            // Get top 5 books
            const topBooks = Object.entries(bookBorrowCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const labels = topBooks.map(([bookId, count]) => {
                const book = window.libraryApp.books.find(b => b.id === parseInt(bookId));
                return book ? book.title.substring(0, 20) + '...' : 'Không tìm thấy';
            });

            const data = topBooks.map(([bookId, count]) => count);

            popularBooksChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lần mượn',
                        data: data,
                        backgroundColor: [
                            '#667eea',
                            '#f093fb',
                            '#f6d365',
                            '#fda085',
                            '#96deda'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Count books by category
            const categoryCounts = {};
            window.libraryApp.books.forEach(book => {
                categoryCounts[book.category] = (categoryCounts[book.category] || 0) + 1;
            });

            const labels = Object.keys(categoryCounts);
            const data = Object.values(categoryCounts);

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea',
                            '#f093fb',
                            '#f6d365',
                            '#fda085',
                            '#96deda',
                            '#a8e6cf',
                            '#ffd93d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createUserActivityChart() {
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            
            // Generate weekly activity data
            const weeks = [];
            const newUsers = [];
            const activeUsers = [];
            
            for (let i = 7; i >= 0; i--) {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - (i * 7));
                const startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                weeks.push(`Tuần ${8-i}`);
                
                // New users in this week
                const newUsersCount = window.libraryApp.users.filter(user => {
                    const joinDate = new Date(user.joinDate);
                    return joinDate >= startDate && joinDate <= endDate;
                }).length;
                newUsers.push(newUsersCount);
                
                // Active users in this week (users who borrowed books)
                const activeUsersCount = new Set(
                    window.libraryApp.borrowRecords
                        .filter(record => {
                            const borrowDate = new Date(record.borrowDate);
                            return borrowDate >= startDate && borrowDate <= endDate;
                        })
                        .map(record => record.userId)
                ).size;
                activeUsers.push(activeUsersCount);
            }

            userActivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Người dùng mới',
                            data: newUsers,
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'Người dùng hoạt động',
                            data: activeUsers,
                            backgroundColor: '#f093fb'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function loadDetailedReports() {
            loadTopBooksReport();
            loadLeastBorrowedBooksReport();
            loadActiveUsersReport();
            loadOverdueUsersReport();
            loadPerformanceMetrics();
            generateRecommendations();
        }

        function loadTopBooksReport() {
            const bookBorrowCounts = {};
            window.libraryApp.borrowRecords.forEach(record => {
                bookBorrowCounts[record.bookId] = (bookBorrowCounts[record.bookId] || 0) + 1;
            });

            const topBooks = Object.entries(bookBorrowCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const tbody = document.getElementById('topBooksTable');
            tbody.innerHTML = topBooks.map(([bookId, count]) => {
                const book = window.libraryApp.books.find(b => b.id === parseInt(bookId));
                if (!book) return '';
                
                return `
                    <tr>
                        <td><strong>${book.title}</strong></td>
                        <td>${book.author}</td>
                        <td><span class="badge badge-success">${count}</span></td>
                        <td><i class="fas fa-arrow-up text-success"></i></td>
                    </tr>
                `;
            }).join('');
        }

        function loadLeastBorrowedBooksReport() {
            const bookBorrowCounts = {};
            window.libraryApp.borrowRecords.forEach(record => {
                bookBorrowCounts[record.bookId] = (bookBorrowCounts[record.bookId] || 0) + 1;
            });

            const leastBorrowed = window.libraryApp.books
                .filter(book => (bookBorrowCounts[book.id] || 0) <= 2)
                .sort((a, b) => (bookBorrowCounts[a.id] || 0) - (bookBorrowCounts[b.id] || 0))
                .slice(0, 10);

            const tbody = document.getElementById('leastBorrowedBooksTable');
            tbody.innerHTML = leastBorrowed.map(book => {
                const borrowCount = bookBorrowCounts[book.id] || 0;
                return `
                    <tr>
                        <td><strong>${book.title}</strong></td>
                        <td>${book.author}</td>
                        <td><span class="badge badge-warning">${borrowCount}</span></td>
                        <td>${window.libraryApp.formatDate(book.publishedDate)}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadActiveUsersReport() {
            const userBorrowCounts = {};
            window.libraryApp.borrowRecords.forEach(record => {
                userBorrowCounts[record.userId] = (userBorrowCounts[record.userId] || 0) + 1;
            });

            const activeUsers = Object.entries(userBorrowCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const tbody = document.getElementById('activeUsersTable');
            tbody.innerHTML = activeUsers.map(([userId, count]) => {
                const user = window.libraryApp.users.find(u => u.id === parseInt(userId));
                if (!user) return '';
                
                return `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-primary">${count}</span></td>
                        <td>${window.libraryApp.formatDate(user.joinDate)}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadOverdueUsersReport() {
            const overdueRecords = window.libraryApp.borrowRecords.filter(record => {
                return record.status === 'borrowed' && new Date(record.dueDate) < new Date();
            });

            const overdueUsers = {};
            overdueRecords.forEach(record => {
                if (!overdueUsers[record.userId]) {
                    overdueUsers[record.userId] = [];
                }
                overdueUsers[record.userId].push(record);
            });

            const tbody = document.getElementById('overdueUsersTable');
            tbody.innerHTML = Object.entries(overdueUsers).map(([userId, records]) => {
                const user = window.libraryApp.users.find(u => u.id === parseInt(userId));
                if (!user) return '';
                
                const oldestOverdue = records.reduce((oldest, record) => {
                    return new Date(record.dueDate) < new Date(oldest.dueDate) ? record : oldest;
                });
                
                const daysOverdue = Math.floor((new Date() - new Date(oldestOverdue.dueDate)) / (1000 * 60 * 60 * 24));
                
                return `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td><span class="badge badge-danger">${records.length}</span></td>
                        <td>${daysOverdue} ngày</td>
                        <td>
                            <button class="btn btn-outline btn-small" onclick="contactUser(${userId})">
                                <i class="fas fa-envelope"></i> Liên hệ
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadPerformanceMetrics() {
            // Library efficiency
            const totalBooks = window.libraryApp.books.reduce((sum, book) => sum + book.quantity, 0);
            const borrowedBooks = window.libraryApp.borrowRecords.filter(r => r.status === 'borrowed').length;
            const efficiency = totalBooks > 0 ? ((borrowedBooks / totalBooks) * 100).toFixed(0) : 0;
            
            document.getElementById('libraryEfficiency').textContent = efficiency + '%';
            document.getElementById('efficiencyProgress').style.width = efficiency + '%';

            // Average borrow time
            const returnedRecords = window.libraryApp.borrowRecords.filter(r => r.returnDate);
            let totalDays = 0;
            returnedRecords.forEach(record => {
                const borrowDate = new Date(record.borrowDate);
                const returnDate = new Date(record.returnDate);
                totalDays += (returnDate - borrowDate) / (1000 * 60 * 60 * 24);
            });
            const avgBorrowTime = returnedRecords.length > 0 ? Math.round(totalDays / returnedRecords.length) : 0;
            document.getElementById('avgBorrowTime').textContent = avgBorrowTime + ' ngày';

            // On-time return rate
            const onTimeReturns = returnedRecords.filter(record => {
                return new Date(record.returnDate) <= new Date(record.dueDate);
            }).length;
            const onTimeRate = returnedRecords.length > 0 ? ((onTimeReturns / returnedRecords.length) * 100).toFixed(0) : 0;
            
            document.getElementById('onTimeReturnRate').textContent = onTimeRate + '%';
            document.getElementById('onTimeProgress').style.width = onTimeRate + '%';

            // User growth rate (simplified)
            document.getElementById('userGrowthRate').textContent = '+15%';
        }

        function generateRecommendations() {
            const recommendations = [];
            
            // Check overdue rate
            const overdueRecords = window.libraryApp.borrowRecords.filter(record => {
                return record.status === 'borrowed' && new Date(record.dueDate) < new Date();
            });
            const overdueRate = (overdueRecords.length / window.libraryApp.borrowRecords.filter(r => r.status === 'borrowed').length) * 100;
            
            if (overdueRate > 10) {
                recommendations.push({
                    type: 'warning',
                    title: 'Tỷ lệ quá hạn cao',
                    description: `Tỷ lệ quá hạn hiện tại là ${overdueRate.toFixed(1)}%. Nên gửi nhắc nhở sớm hơn và áp dụng chính sách phạt.`
                });
            }

            // Check popular categories
            const categoryCounts = {};
            window.libraryApp.borrowRecords.forEach(record => {
                const book = window.libraryApp.books.find(b => b.id === record.bookId);
                if (book) {
                    categoryCounts[book.category] = (categoryCounts[book.category] || 0) + 1;
                }
            });
            
            const topCategory = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1])[0];
            if (topCategory) {
                recommendations.push({
                    type: 'info',
                    title: 'Thể loại phổ biến',
                    description: `"${topCategory[0]}" là thể loại được mượn nhiều nhất. Nên bổ sung thêm sách thuộc thể loại này.`
                });
            }

            // Check inactive books
            const bookBorrowCounts = {};
            window.libraryApp.borrowRecords.forEach(record => {
                bookBorrowCounts[record.bookId] = (bookBorrowCounts[record.bookId] || 0) + 1;
            });
            
            const inactiveBooks = window.libraryApp.books.filter(book => (bookBorrowCounts[book.id] || 0) === 0);
            if (inactiveBooks.length > 0) {
                recommendations.push({
                    type: 'warning',
                    title: 'Sách chưa được mượn',
                    description: `Có ${inactiveBooks.length} cuốn sách chưa từng được mượn. Nên xem xét tổ chức sự kiện quảng bá hoặc điều chỉnh vị trí.`
                });
            }

            // Display recommendations
            const container = document.getElementById('recommendationsList');
            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item ${rec.type}">
                    <i class="fas fa-${rec.type === 'warning' ? 'exclamation-triangle' : 'lightbulb'}"></i>
                    <div>
                        <h5>${rec.title}</h5>
                        <p>${rec.description}</p>
                    </div>
                </div>
            `).join('');
        }

        function applyCustomRange() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (startDate && endDate && startDate <= endDate) {
                currentPeriod = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                loadReportsData();
                document.querySelector('.custom-range').style.display = 'none';
            }
        }

        function refreshReports() {
            loadReportsData();
            window.libraryApp.showAlert('Báo cáo đã được làm mới!');
        }

        function exportReport() {
            // Generate report content
            const reportContent = `
                BÁO CÁO THỐNG KÊ THƯ VIỆN MINI
                ====================================
                Thời gian: ${new Date().toLocaleString('vi-VN')}
                
                TỔNG QUAN
                ---------
                - Tổng lượt mượn: ${document.getElementById('totalBorrowsInPeriod').textContent}
                - Người dùng hoạt động: ${document.getElementById('activeUsersInPeriod').textContent}
                - Trung bình sách/người: ${document.getElementById('avgBooksPerUser').textContent}
                - Tỷ lệ quá hạn: ${document.getElementById('overdueRate').textContent}
                
                HIỆU SUẤT
                ---------
                - Hiệu quả thư viện: ${document.getElementById('libraryEfficiency').textContent}
                - Thời gian mượn TB: ${document.getElementById('avgBorrowTime').textContent}
                - Tỷ lệ trả đúng hạn: ${document.getElementById('onTimeReturnRate').textContent}
                
                Báo cáo được tạo bởi Hệ thống Quản lý Thư viện Mini
            `;
            
            // Create and download file
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bao-cao-thu-vien-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            window.libraryApp.showAlert('Báo cáo đã được xuất thành công!');
        }

        function contactUser(userId) {
            const user = window.libraryApp.users.find(u => u.id === userId);
            if (user) {
                window.libraryApp.showAlert(`Đã gửi email nhắc nhở đến ${user.email}`, 'success');
            }
        }
    </script>

    <style>
        .time-filter {
            margin-bottom: 2rem;
        }

        .filter-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .filter-card h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .filter-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .custom-range {
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .gradient-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .gradient-green { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; }
        .gradient-orange { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; }
        .gradient-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .stat-info p {
            margin-bottom: 0.3rem;
            opacity: 0.9;
        }

        .stat-info small {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .charts-section {
            margin-bottom: 3rem;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .chart-header h3 {
            color: #333;
            font-size: 1.1rem;
        }

        .chart-controls select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .detailed-reports {
            background: white;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .reports-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-btn {
            padding: 1rem 2rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-btn.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .report-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .report-card h4 {
            background: #f8f9fa;
            padding: 1rem;
            margin: 0;
            border-bottom: 1px solid #e9ecef;
            color: #333;
        }

        .report-table {
            max-height: 400px;
            overflow-y: auto;
        }

        .report-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .report-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .badge {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-primary { background: #d1ecf1; color: #0c5460; }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }

        .metric-card h4 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 0.9rem;
        }

        .metric-value span {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            display: block;
            margin-bottom: 0.5rem;
        }

        .metric-value small {
            color: #666;
            font-size: 0.8rem;
        }

        .metric-progress {
            margin-top: 1rem;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .recommendations h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .recommendation-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid;
        }

        .recommendation-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .recommendation-item.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .recommendation-item i {
            color: inherit;
            margin-top: 0.2rem;
        }

        .recommendation-item h5 {
            margin-bottom: 0.5rem;
            color: inherit;
        }

        .recommendation-item p {
            margin: 0;
            color: inherit;
            opacity: 0.8;
        }

        .text-success { color: #28a745 !important; }

        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .performance-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-options {
                flex-direction: column;
            }
            
            .reports-tabs {
                overflow-x: auto;
            }
        }
    </style>
</body>
</html>